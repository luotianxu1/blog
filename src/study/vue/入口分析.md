---
title: 入口分析
icon: markdown
order: 1
date: 2023-08-29
category:
    - Vue
tag:
    - 入口
---

## 一、主入口分析

### package.json

```javascript
"scripts": {
    // ...
    "build": "node scripts/build.js",
    // ...
  },
```

### scripts/build.js

```javascript
let builds = require('./config').getAllBuilds()
build(builds)
```

### scripts/config.js

```javascript
// Runtime+compiler ES modules build (for direct import in browser)
  'web-full-esm-browser-prod': {
    entry: resolve('web/entry-runtime-with-compiler.js'),
    dest: resolve('dist/vue.esm.browser.min.js'),
    format: 'es',
    transpile: false,
    env: 'production',
    alias: { he: './entity-decoder' },
    banner
  }
```

### src/platforms/web/entry-runtime-with-compiler.js

```javascript
// ...
import Vue from './runtime/index'
import { compileToFunctions } from './compiler/index'
// ...
Vue.prototype.$mount = function () {
 // ...
}
Vue.compile = compileToFunctions

export default Vue
```

### src/platforms/web/runtime/index.js

```javascript
import Vue from 'core/index'
// ...
export default Vue
```

### src/core/index.js

```javascript
import Vue from './instance/index'
import { initGlobalAPI } from './global-api/index'
// ...
initGlobalAPI(Vue)
// ...
export default Vue
```

### src/core/instance/index.js

```javascript
import { initMixin } from './init'
import { stateMixin } from './state'
import { renderMixin } from './render'
import { eventsMixin } from './events'
import { lifecycleMixin } from './lifecycle'
import { warn } from '../util/index'

function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &&
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options)
}

initMixin(Vue)
stateMixin(Vue)
eventsMixin(Vue)
lifecycleMixin(Vue)
renderMixin(Vue)

export default Vue
```

## 二、方法

### initMixin

vue在此方法中声明了_init方法。这实际上就是我们使用vue时， new Vue(options)，实例化vue时执行的方法。此方法核心流程如下：

#### 1. 合并options配置，并挂载至 vm.$options上

#### 2. initLifecycle

初始化vm.$parent, vm.$root, vm.$children, vm.$refs 等属性值

#### 3. initEvents

初始化vm._events={}，初始化事件系统
实际上是父组件在模板中使用v-on或@注册的监听子组件内触发的事件

#### 4. initRender

主要定义2个方法：

vm._c，此方法用于用户使用template模式
vm.$createElement，此方法用于用户手写render函数

这2个方法，最终都会调用createElement方法，createElement方法将在虚拟DOM章节重点分析，这里我们只需知道，此方法返回虚拟DOM

#### 5. 调用 beforeCreate 钩子

#### 6. initInjections

此方法，里面的inject和provide是成对出现的。作用是父组件提供数据，任意嵌套层级的子组件可以去接受。其中provide是数据提供方，inject是数据接受方。

#### 7. initState

初始化state, props, methods, computed, watch
其中初始化state, props, methods时， vue会遍历data中所有的key，检测是否在props，methods重复定义
props变量有多种写法，vue会进行统一转化，转化成{ a: {type: "xx", default: 'xx'} }
将data, props都挂载到vm._data, vm._props上。设置访问数据代理，访问this.xx，实际上访问的是vm._data[xx], vm._props[xx]
给_data,_props添加响应式监听

#### 8. initProvide

同initInjections

#### 9. 调用 created 钩子

### stateMixin

- 定义Vue.prototype.$data,  Vue.prototype.$props为响应式。
- 获取vm.$data实际上是获取vm._data， vm.$props实际上是vm._props
- 定义Vue.prototype.$watch方法，实际上是实例化Watcher类

### eventsMixin

- 在Vue原型上，定义$on, $once, $off, $emit 事件方法，并返回vm

### lifecycleMixin

- 在Vue.prototype上定义 _update, $forceUpdate, $destroy方法

### renderMixin

- 在Vue原型上，定义$nextTick方法
- 在Vue原型上，定义_render方法，值得注意的是，该方法会调用vm.$createElement创建虚拟DOM，如果返回值vnode不是虚拟DOM类型，将创建一个空的虚拟DOM。
虚拟DOM:VNode，实际上是一个类。

## 三、总结

- Vue本质上，是一个构造函数。
- 初始化了：state, props, methods, computed, watch，$destory，$data，$props，$forceUpdate等。
- 对_data,_props使用 Object.defineProperty 添加响应式
- 设置访问数据代理，访问this.xx，实际上访问的是vm._data[xx], vm._props[xx]
- 添加event事件系统，实际上初始化的是父组件在模板中使用v-on或@注册的监听子组件内触发的事件
- 挂载createElement，为后续render返回虚拟DOM做准备。
- 调用对应的组件生命周期钩子， beforeCreate, created
